<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>ndb-core documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">ndb-core documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >EntityFormService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/core/common-components/entity-form/entity-form.service.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>This service provides helper functions for creating tables or forms for an entity as well as saving
new changes correctly to the entity.</p>

            </p>



            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Async</span>
                                <a href="#createEntityForm" >createEntityForm</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#extendFormFieldConfig" >extendFormFieldConfig</a>
                            </li>
                            <li>
                                <a href="#resetForm" >resetForm</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Async</span>
                                <a href="#saveChanges" >saveChanges</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(fb: FormBuilder, entityMapper: <a href="../injectables/EntityMapperService.html" target="_self">EntityMapperService</a>, entitySchemaService: <a href="../injectables/EntitySchemaService.html" target="_self">EntitySchemaService</a>, dynamicValidator: <a href="../injectables/DynamicValidatorsService.html" target="_self">DynamicValidatorsService</a>, ability: <a href="../injectables/EntityAbility.html" target="_self">EntityAbility</a>, unsavedChanges: <a href="../injectables/UnsavedChangesService.html" target="_self">UnsavedChangesService</a>, defaultValueService: <a href="../injectables/DefaultValueService.html" target="_self">DefaultValueService</a>, router: Router)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="56" class="link-to-prism">src/app/core/common-components/entity-form/entity-form.service.ts:56</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>fb</td>
                                                  
                                                        <td>
                                                                    <code>FormBuilder</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>entityMapper</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/EntityMapperService.html" target="_self" >EntityMapperService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>entitySchemaService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/EntitySchemaService.html" target="_self" >EntitySchemaService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>dynamicValidator</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DynamicValidatorsService.html" target="_self" >DynamicValidatorsService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>ability</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/EntityAbility.html" target="_self" >EntityAbility</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>unsavedChanges</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/UnsavedChangesService.html" target="_self" >UnsavedChangesService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>defaultValueService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/DefaultValueService.html" target="_self" >DefaultValueService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>router</td>
                                                  
                                                        <td>
                                                                    <code>Router</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createEntityForm"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Async</span>
                        <span ><b>createEntityForm</b></span>
                        <a href="#createEntityForm"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createEntityForm(formFields: <a href="../classes/Config.html" target="_self">ColumnConfig[]</a>, entity: T, forTable, withPermissionCheck)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="140"
                                    class="link-to-prism">src/app/core/common-components/entity-form/entity-form.service.ts:140</a></div>
                        </td>
                    </tr>

                    <tr>
                        <td class="col-md-4">
                            <b>Type parameters :</b>
                            <ul class="type-parameters">
                                    <li>T</li>
                            </ul>
                        </td>
                    </tr>

            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Creates a form with the formFields and the existing values from the entity.
Missing fields in the formFields are filled with schema information.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>formFields</td>
                                            <td>
                                                            <code><a href="../classes/Config.html" target="_self" >ColumnConfig[]</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                            <td>
                                            </td>
                                        </tr>
                                        <tr>
                                                <td>entity</td>
                                            <td>
                                                        <code>T</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                            <td>
                                            </td>
                                        </tr>
                                        <tr>
                                                <td>forTable</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>false</code>
                                            </td>

                                            <td>
                                            </td>
                                        </tr>
                                        <tr>
                                                <td>withPermissionCheck</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>true</code>
                                            </td>

                                            <td>
                                                    <p>if true, fields without &#39;update&#39; permissions will stay disabled when enabling form</p>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/EntityForm.html" target="_self" >Promise&lt;EntityForm&lt;T&gt;&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="extendFormFieldConfig"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                        <span ><b>extendFormFieldConfig</b></span>
                        <a href="#extendFormFieldConfig"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>extendFormFieldConfig(formField: <a href="../undefineds/ColumnConfig.html" target="_self">ColumnConfig</a>, entityType: <a href="../undefineds/EntityConstructor.html" target="_self">EntityConstructor</a>, forTable)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="84"
                                    class="link-to-prism">src/app/core/common-components/entity-form/entity-form.service.ts:84</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Uses schema information to fill missing fields in the FormFieldConfig.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>formField</td>
                                            <td>
                                                            <code><a href="../miscellaneous/typealiases.html#ColumnConfig" target="_self" >ColumnConfig</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>entityType</td>
                                            <td>
                                                            <code><a href="../miscellaneous/typealiases.html#EntityConstructor" target="_self" >EntityConstructor</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>forTable</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>false</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/FormFieldConfig.html" target="_self" >FormFieldConfig</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="resetForm"></a>
                    <span class="name">
                        <span ><b>resetForm</b></span>
                        <a href="#resetForm"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>resetForm(form: <a href="../interfaces/EntityForm.html" target="_self">EntityFormGroup&lt;E&gt;</a>, entity: E)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="316"
                                    class="link-to-prism">src/app/core/common-components/entity-form/entity-form.service.ts:316</a></div>
                        </td>
                    </tr>

                    <tr>
                        <td class="col-md-4">
                            <b>Type parameters :</b>
                            <ul class="type-parameters">
                                    <li>E</li>
                            </ul>
                        </td>
                    </tr>

            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>form</td>
                                            <td>
                                                            <code><a href="../interfaces/EntityForm.html" target="_self" >EntityFormGroup&lt;E&gt;</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>entity</td>
                                            <td>
                                                        <code>E</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="saveChanges"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Async</span>
                        <span ><b>saveChanges</b></span>
                        <a href="#saveChanges"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>saveChanges(form: <a href="../interfaces/EntityForm.html" target="_self">EntityFormGroup&lt;T&gt;</a>, entity: T)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="257"
                                    class="link-to-prism">src/app/core/common-components/entity-form/entity-form.service.ts:257</a></div>
                        </td>
                    </tr>

                    <tr>
                        <td class="col-md-4">
                            <b>Type parameters :</b>
                            <ul class="type-parameters">
                                    <li>T</li>
                            </ul>
                        </td>
                    </tr>

            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>This function applies the changes of the formGroup to the entity.
If the form is invalid or the entity does not pass validation after applying the changes, an error will be thrown.
The input entity will not be modified but a copy of it will be returned in case of success.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>form</td>
                                            <td>
                                                            <code><a href="../interfaces/EntityForm.html" target="_self" >EntityFormGroup&lt;T&gt;</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <p>The formGroup holding the changes (marked pristine and disabled after successful save)</p>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>entity</td>
                                            <td>
                                                        <code>T</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <p>The entity on which the changes should be applied.</p>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;T&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>a copy of the input entity with the changes from the form group</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &quot;@angular/core&quot;;
import {
  FormBuilder,
  FormControl,
  FormControlOptions,
  FormGroup,
  ɵElement,
} from &quot;@angular/forms&quot;;
import { ColumnConfig, FormFieldConfig, toFormFieldConfig } from &quot;./FormConfig&quot;;
import { Entity, EntityConstructor } from &quot;../../entity/model/entity&quot;;
import { EntityMapperService } from &quot;../../entity/entity-mapper/entity-mapper.service&quot;;
import { EntitySchemaService } from &quot;../../entity/schema/entity-schema.service&quot;;
import { DynamicValidatorsService } from &quot;./dynamic-form-validators/dynamic-validators.service&quot;;
import { EntityAbility } from &quot;../../permissions/ability/entity-ability&quot;;
import { InvalidFormFieldError } from &quot;./invalid-form-field.error&quot;;
import { UnsavedChangesService } from &quot;../../entity-details/form/unsaved-changes.service&quot;;
import { ActivationStart, Router } from &quot;@angular/router&quot;;
import { Subscription } from &quot;rxjs&quot;;
import { filter } from &quot;rxjs/operators&quot;;
import { EntitySchemaField } from &quot;../../entity/schema/entity-schema-field&quot;;
import { DefaultValueService } from &quot;../../default-values/default-value.service&quot;;
import { DefaultValueConfig } from &quot;../../entity/schema/default-value-config&quot;;

/**
 * These are utility types that allow to define the type of &#x60;FormGroup&#x60; the way it is returned by &#x60;EntityFormService.create&#x60;
 */
export type TypedFormGroup&lt;T&gt; &#x3D; FormGroup&lt;{
  [K in keyof T]: ɵElement&lt;T[K], null&gt;;
}&gt;;

export type EntityFormGroup&lt;T extends Entity&gt; &#x3D; TypedFormGroup&lt;Partial&lt;T&gt;&gt;;

export interface EntityForm&lt;T extends Entity&gt; {
  formGroup: EntityFormGroup&lt;T&gt;;
  entity: T;

  /**
   * map of field ids to the default value configuration for that field
   */
  defaultValueConfigs: Map&lt;string, DefaultValueConfig&gt;;

  /**
   * map of field ids to the current value to be inherited from the referenced parent entities&#x27; field
   */
  inheritedParentValues: Map&lt;string, any&gt;;

  watcher: Map&lt;string, Subscription&gt;;
}

/**
 * This service provides helper functions for creating tables or forms for an entity as well as saving
 * new changes correctly to the entity.
 */
@Injectable({ providedIn: &quot;root&quot; })
export class EntityFormService {
  private subscriptions: Subscription[] &#x3D; [];

  constructor(
    private fb: FormBuilder,
    private entityMapper: EntityMapperService,
    private entitySchemaService: EntitySchemaService,
    private dynamicValidator: DynamicValidatorsService,
    private ability: EntityAbility,
    private unsavedChanges: UnsavedChangesService,
    private defaultValueService: DefaultValueService,
    router: Router,
  ) {
    router.events
      .pipe(filter((e) &#x3D;&gt; e instanceof ActivationStart))
      .subscribe(() &#x3D;&gt; {
        // Clean up everything once navigation happens
        this.subscriptions.forEach((sub) &#x3D;&gt; sub.unsubscribe());
        this.subscriptions &#x3D; [];
        this.unsavedChanges.pending &#x3D; false;
      });
  }

  /**
   * Uses schema information to fill missing fields in the FormFieldConfig.
   * @param formField
   * @param entityType
   * @param forTable
   */
  public extendFormFieldConfig(
    formField: ColumnConfig,
    entityType: EntityConstructor,
    forTable &#x3D; false,
  ): FormFieldConfig {
    const fullField &#x3D; toFormFieldConfig(formField);
    try {
      return this.addSchemaToFormField(
        fullField,
        entityType.schema.get(fullField.id),
        forTable,
      );
    } catch (err) {
      throw new Error(
        &#x60;Could not create form config for ${fullField.id}: ${err}&#x60;,
      );
    }
  }

  private addSchemaToFormField(
    formField: FormFieldConfig,
    propertySchema: EntitySchemaField,
    forTable: boolean,
  ): FormFieldConfig {
    // formField config has precedence over schema
    const fullField &#x3D; Object.assign({}, propertySchema, formField);

    fullField.editComponent &#x3D;
      fullField.editComponent ||
      this.entitySchemaService.getComponent(propertySchema, &quot;edit&quot;);
    fullField.viewComponent &#x3D;
      fullField.viewComponent ||
      this.entitySchemaService.getComponent(propertySchema, &quot;view&quot;);

    if (forTable) {
      fullField.forTable &#x3D; true;
      fullField.label &#x3D;
        fullField.label || fullField.labelShort || fullField.label;
      delete fullField.description;
    } else {
      fullField.forTable &#x3D; false;
      fullField.label &#x3D;
        fullField.label || fullField.label || fullField.labelShort;
    }

    return fullField;
  }

  /**
   * Creates a form with the formFields and the existing values from the entity.
   * Missing fields in the formFields are filled with schema information.
   * @param formFields
   * @param entity
   * @param forTable
   * @param withPermissionCheck if true, fields without &#x27;update&#x27; permissions will stay disabled when enabling form
   */
  public async createEntityForm&lt;T extends Entity&gt;(
    formFields: ColumnConfig[],
    entity: T,
    forTable &#x3D; false,
    withPermissionCheck &#x3D; true,
  ): Promise&lt;EntityForm&lt;T&gt;&gt; {
    const typedFormGroup: TypedFormGroup&lt;Partial&lt;T&gt;&gt; &#x3D; this.createFormGroup(
      formFields,
      entity,
      forTable,
      withPermissionCheck,
    );

    const defaultValueConfigs &#x3D;
      DefaultValueService.getDefaultValueConfigs(entity);

    const entityForm: EntityForm&lt;T&gt; &#x3D; {
      formGroup: typedFormGroup,
      entity: entity,
      defaultValueConfigs: defaultValueConfigs,
      inheritedParentValues: new Map(),
      watcher: new Map(),
    };

    await this.defaultValueService.handleEntityForm(entityForm, entity);

    return entityForm;
  }

  private createFormGroup&lt;T extends Entity&gt;(
    formFields: ColumnConfig[],
    entity: T,
    forTable &#x3D; false,
    withPermissionCheck &#x3D; true,
  ): EntityFormGroup&lt;T&gt; {
    const formConfig &#x3D; {};
    const copy &#x3D; entity.copy();

    formFields &#x3D; formFields.filter((f) &#x3D;&gt;
      entity.getSchema().has(toFormFieldConfig(f).id),
    );

    for (const f of formFields) {
      this.addFormControlConfig(formConfig, f, copy, forTable);
    }
    const group &#x3D; this.fb.group&lt;Partial&lt;T&gt;&gt;(formConfig);

    const valueChangesSubscription &#x3D; group.valueChanges.subscribe(
      () &#x3D;&gt; (this.unsavedChanges.pending &#x3D; group.dirty),
    );

    this.subscriptions.push(valueChangesSubscription);

    if (withPermissionCheck) {
      this.disableReadOnlyFormControls(group, entity);
      const statusChangesSubscription &#x3D; group.statusChanges
        .pipe(filter((status) &#x3D;&gt; status !&#x3D;&#x3D; &quot;DISABLED&quot;))
        .subscribe(() &#x3D;&gt; this.disableReadOnlyFormControls(group, entity));
      this.subscriptions.push(statusChangesSubscription);
    }

    return group;
  }

  /**
   * Add a property with form control initialization config to the given formConfig object.
   * @param formConfig
   * @param fieldConfig
   * @param entity
   * @param forTable
   * @private
   */
  private addFormControlConfig(
    formConfig: { [key: string]: FormControl },
    fieldConfig: ColumnConfig,
    entity: Entity,
    forTable: boolean,
  ) {
    const field &#x3D; this.extendFormFieldConfig(
      fieldConfig,
      entity.getConstructor(),
      forTable,
    );

    let value &#x3D; entity[field.id];

    const controlOptions: FormControlOptions &#x3D; { nonNullable: true };
    if (field.validators) {
      const validators &#x3D; this.dynamicValidator.buildValidators(
        field.validators,
      );
      Object.assign(controlOptions, validators);
    }

    formConfig[field.id] &#x3D; new FormControl(value, controlOptions);
  }

  private disableReadOnlyFormControls&lt;T extends Entity&gt;(
    form: EntityFormGroup&lt;T&gt;,
    entity: T,
  ) {
    const action &#x3D; entity.isNew ? &quot;create&quot; : &quot;update&quot;;
    Object.keys(form.controls).forEach((fieldId) &#x3D;&gt; {
      if (this.ability.cannot(action, entity, fieldId)) {
        form.get(fieldId).disable({ onlySelf: true, emitEvent: false });
      }
    });
  }

  /**
   * This function applies the changes of the formGroup to the entity.
   * If the form is invalid or the entity does not pass validation after applying the changes, an error will be thrown.
   * The input entity will not be modified but a copy of it will be returned in case of success.
   * @param form The formGroup holding the changes (marked pristine and disabled after successful save)
   * @param entity The entity on which the changes should be applied.
   * @returns a copy of the input entity with the changes from the form group
   */
  public async saveChanges&lt;T extends Entity&gt;(
    form: EntityFormGroup&lt;T&gt;,
    entity: T,
  ): Promise&lt;T&gt; {
    this.checkFormValidity(form);

    const updatedEntity &#x3D; entity.copy() as T;
    for (const [key, value] of Object.entries(form.getRawValue())) {
      if (value !&#x3D;&#x3D; null) {
        updatedEntity[key] &#x3D; value;
      }
    }

    updatedEntity.assertValid();
    this.assertPermissionsToSave(entity, updatedEntity);

    try {
      await this.entityMapper.save(updatedEntity);
    } catch (err) {
      throw new Error($localize&#x60;Could not save ${entity.getType()}\: ${err}&#x60;);
    }

    this.unsavedChanges.pending &#x3D; false;
    form.markAsPristine();
    form.disable();
    return Object.assign(entity, updatedEntity);
  }

  private checkFormValidity&lt;T extends Entity&gt;(form: EntityFormGroup&lt;T&gt;) {
    // errors regarding invalid fields won&#x27;t be displayed unless marked as touched
    form.markAllAsTouched();
    if (form.invalid) {
      throw new InvalidFormFieldError();
    }
  }

  private assertPermissionsToSave(oldEntity: Entity, newEntity: Entity) {
    let action: &quot;create&quot; | &quot;update&quot;, entity: Entity;
    if (oldEntity.isNew) {
      action &#x3D; &quot;create&quot;;
      entity &#x3D; newEntity;
    } else {
      action &#x3D; &quot;update&quot;;
      entity &#x3D; oldEntity;
    }

    if (!this.ability.can(action, entity, undefined, true)) {
      const conditions &#x3D; this.ability
        .rulesFor(action, entity.getType())
        .map((r) &#x3D;&gt; r.conditions);

      throw new Error(
        $localize&#x60;Current user is not permitted to save these changes: ${JSON.stringify(
          conditions,
        )}&#x60;,
      );
    }
  }

  resetForm&lt;E extends Entity&gt;(form: EntityFormGroup&lt;E&gt;, entity: E) {
    for (const key of Object.keys(form.controls)) {
      form.get(key).setValue(entity[key]);
    }

    form.markAsPristine();
    this.unsavedChanges.pending &#x3D; false;
  }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'EntityFormService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
